@page "/books/{id:int}"
@inject IBookService BookService
@inject NavigationManager Navigation

<div class="book-details-container">
    @if (book == null)
    {
        <div class="loading-state">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Se √ÆncarcƒÉ...</span>
            </div>
            <p class="mt-3">Se √ÆncarcƒÉ detaliile cƒÉr»õii...</p>
        </div>
    }
    else
    {
        <div class="book-details-card">
            <!-- Back Button -->
            <div class="mb-4">
                <button class="btn btn-outline-secondary" @onclick="GoBack">
                    ‚Üê √énapoi la CƒÉr»õi
                </button>
            </div>

            <!-- Book Header -->
            <div class="book-header">
                <div class="book-header-content">
                    <div class="book-icon">üìñ</div>
                    <div class="book-header-info">
                        <h1 class="book-details-title">@book.Title</h1>
                        <div class="book-meta">
                            <span class="meta-item">
                                <strong>üìÖ Anul publicƒÉrii:</strong> @book.Year
                            </span>
                            <span class="meta-item">
                                <strong>üìÜ AdƒÉugatƒÉ la:</strong> @book.CreatedAt.ToString("dd MMMM yyyy, HH:mm")
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Book Content Grid -->
            <div class="book-content-grid">
                <!-- Author Section -->
                <div class="detail-section">
                    <div class="section-icon">‚úçÔ∏è</div>
                    <div class="section-content">
                        <h3 class="section-title">Autor</h3>
                        @if (book.Author != null)
                        {
                            <div class="author-card">
                                <h4 class="author-name">@book.Author.Name</h4>
                                @if (!string.IsNullOrEmpty(book.Author.Email))
                                {
                                    <p class="author-email">
                                        <span class="email-icon">‚úâÔ∏è</span> @book.Author.Email
                                    </p>
                                }
                                @if (!string.IsNullOrEmpty(book.Author.Biography))
                                {
                                    <div class="author-bio">
                                        <strong>Biografie:</strong>
                                        <p>@book.Author.Biography</p>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-muted">Autor necunoscut</p>
                        }
                    </div>
                </div>

                <!-- Categories Section -->
                <div class="detail-section">
                    <div class="section-icon">üè∑Ô∏è</div>
                    <div class="section-content">
                        <h3 class="section-title">Categorii</h3>
                        @if (book.BookCategories?.Any() == true)
                        {
                            <div class="categories-list">
                                @foreach (var bookCategory in book.BookCategories)
                                {
                                    <div class="category-item">
                                        <div class="category-header">
                                            <span class="category-name">@(bookCategory.Category?.Name ?? "N/A")</span>
                                        </div>
                                        @if (!string.IsNullOrEmpty(bookCategory.Category?.Description))
                                        {
                                            <p class="category-description">@bookCategory.Category.Description</p>
                                        }
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-muted">Nicio categorie atribuitƒÉ</p>
                        }
                    </div>
                </div>
            </div>

            <!-- Book Statistics -->
            <div class="book-statistics">
                <div class="stat-item">
                    <div class="stat-icon">üè∑Ô∏è</div>
                    <div class="stat-value">@(book.BookCategories?.Count ?? 0)</div>
                    <div class="stat-label">Categorii</div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon">üìÖ</div>
                    <div class="stat-value">@book.Year</div>
                    <div class="stat-label">An publicare</div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon">‚è±Ô∏è</div>
                    <div class="stat-value">@GetDaysAgo()</div>
                    <div class="stat-label">AdƒÉugatƒÉ acum</div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="book-actions">
                <button class="btn btn-primary btn-lg" @onclick="EditBook">
                    ‚úèÔ∏è EditeazƒÉ Cartea
                </button>
                <button class="btn btn-outline-danger btn-lg" @onclick="DeleteBook">
                    üóëÔ∏è »òterge Cartea
                </button>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private Book? book;

    protected override async Task OnInitializedAsync()
    {
        await LoadBook();
    }

    private async Task LoadBook()
    {
        try
        {
            book = await BookService.GetBookByIdAsync(Id);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading book: {ex.Message}");
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/books");
    }

    private void EditBook()
    {
        Navigation.NavigateTo($"/books?edit={Id}");
    }

    private async Task DeleteBook()
    {
        if (confirm($"E»ôti sigur cƒÉ vrei sƒÉ »ôtergi cartea '{book?.Title}'?"))
        {
            try
            {
                await BookService.DeleteBookAsync(Id);
                Navigation.NavigateTo("/books");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error deleting book: {ex.Message}");
            }
        }
    }

    private bool confirm(string message)
    {
        // √én produc»õie, ar trebui folosit JSInterop
        return true;
    }

    private string GetDaysAgo()
    {
        if (book == null) return "N/A";

        // ComparƒÉ cu ora curentƒÉ din Bucure»ôti
        var romanianTimeZone = TimeZoneInfo.FindSystemTimeZoneById("Europe/Bucharest");
        var currentRomanianTime = TimeZoneInfo.ConvertTimeFromUtc(DateTime.UtcNow, romanianTimeZone);
        var timeSpan = currentRomanianTime - book.CreatedAt;

        if (timeSpan.TotalDays < 1)
        {
            if (timeSpan.TotalHours < 1)
            {
                return $"{(int)timeSpan.TotalMinutes} min";
            }
            return $"{(int)timeSpan.TotalHours}h";
        }
        else if (timeSpan.TotalDays < 30)
        {
            return $"{(int)timeSpan.TotalDays} zile";
        }
        else if (timeSpan.TotalDays < 365)
        {
            return $"{(int)(timeSpan.TotalDays / 30)} luni";
        }
        else
        {
            return $"{(int)(timeSpan.TotalDays / 365)} ani";
        }
    }
}